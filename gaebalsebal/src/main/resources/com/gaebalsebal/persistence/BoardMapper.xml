<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.gaebalsebal.persistence.BoardMapper">
  
  <sql id="criteria">
    <trim  suffix=" AND " prefixOverrides="OR">
    	<foreach item='type' collection="typeArr">
    	 	<trim prefix="OR">
    	 		<choose>
    	 			<when test="type == 'T'.toString()">
    	 				board_title like '%' || #{keyword} || '%'
    	 			</when>	
    	 			<when test="type == 'C'.toString()">
    	 				board_content like '%' || #{keyword} || '%'
    	 			</when>	    	 			
     	 			<when test="type == 'W'.toString()">
    	 				board_writer like '%' || #{keyword} || '%'
    	 			</when>
				  <when test="type == 'H'.toString()">
				    board_no IN (
				      SELECT DISTINCT board_no 
				      FROM tag 
				      WHERE tag_name IN
				      <foreach index="idx" item="keyword" collection="keywords" open="(" separator="," close=")">
				      <if test="idx !=0">
				         '#'||#{keyword} 
				       </if> 
				      </foreach>
				    )
				  </when>     	   
    			</choose>
    		</trim>	
    	</foreach>	
	 </trim>	   

  </sql>
  
  

  <select id="getListWithPaging" resultType="BoardVO">
 <![CDATA[ 
    SELECT *FROM (
  		  SELECT /*+INDEX_DESC(BOARD BOARD_PK)*/ 
			    ROWNUM RN
			    , board_no
			    , board_writer
			    , member_id
			    , board_title
			    , board_content
			    , board_create_date
			    , board_update_date
			    , board_view
			    , board_like
			    , board_use_yn
			    , board_category
			    , category_type
			    FROM board b 
			    INNER JOIN member m ON b.board_writer = m.member_no 
			    INNER JOIN category c ON b.board_category = c.category_no 
			    
				    ]]>
				    
				     WHERE 

				<include refid="criteria"></include>   
					 <![CDATA[     
	   			 ROWNUM <= #{pageNum} * #{amount}
				]]>
				         <choose>
				          <when test="sort == 'board_no_asc'">
				            ORDER BY board_no ASC
				          </when>
				          <when test="sort == 'board_no_desc'">
				            ORDER BY board_no DESC
				          </when>
				          <when test="sort == 'board_title_asc'">
				            ORDER BY board_title ASC
				          </when>
				          <otherwise>
				            ORDER BY board_no DESC
				          </otherwise>
				        </choose>
					 <![CDATA[ 		    
				)
				WHERE RN > (#{pageNum} -1) * #{amount}
				]]>
			  </select>
  
  
  <select id="getTotalCount" resultType="int">
  	select count(*) from board
  	where
  	
  	<include refid="criteria"></include>
  	
  	board_no > 0
  </select>

<select id="getTagList" resultType="TagVO">
    SELECT tag_name,board_no FROM tag WHERE board_no = #{board_no}
</select>



</mapper>